apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: azure-devops-ocp-agent-bc-template
  annotations:
    description: "Azure Devops OpenShift self hosted agent buildconfig with optional custom CA bundle"
 
parameters:
 
  - name: NAMESPACE
    description: Namespace name
    required: true
 
  - name: GIT_URL
    description: GIT URL For Dockerfile
    required: true
    value: https://github.com/bfarr-rh/azure-devops-ocp-agent.git
 
  - name: OPENSHIFT_VERSION
    description: OpenShift client binary version
    value: "4.9.7"
 
  - name: AZP_AGENT_VERSION
    description: Azure agent version
    value: "2.187.2"
 
  - name: CUSTOM_CA_B64
    description: |
      Optional Base64 encoded CA bundle.
      To generate:
      cat cert1.pem cert2.pem > bundle.pem
      base64 -w 0 bundle.pem
    required: false
 
objects:
 
  - apiVersion: image.openshift.io/v1
    kind: ImageStream
    metadata:
      name: azure-devops-ocp-agent
      namespace: "${NAMESPACE}"
    spec:
      lookupPolicy:
        local: true
 
  - apiVersion: build.openshift.io/v1
    kind: BuildConfig
    metadata:
      name: azure-devops-ocp-agent
      namespace: "${NAMESPACE}"
    spec:
 
      source:
        git:
          uri: ${GIT_URL}
        type: Git
 
      output:
        to:
          kind: ImageStreamTag
          name: azure-devops-ocp-agent:latest
 
      strategy:
        type: Docker
        dockerStrategy:
          dockerfilePath: Dockerfile
          imageOptimizationPolicy: SkipLayers
          buildArgs:
            - name: OPENSHIFT_VERSION
              value: "${OPENSHIFT_VERSION}"
            - name: AZP_AGENT_VERSION
              value: "${AZP_AGENT_VERSION}"
            - name: CUSTOM_CA_B64
              value: "${CUSTOM_CA_B64}"
 
